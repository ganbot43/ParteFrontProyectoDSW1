@{
    ViewData["Title"] = "Historial de Compras";
}

<h2 class="mb-4 fw-bold">Historial de Compras</h2>

<div id="ordenesContainer" class="row row-cols-1 row-cols-md-3 g-4">
    <div class="text-center text-muted">Cargando historial...</div>
</div>

<!-- MODAL DETALLE DE PAGO -->
<div class="modal fade" id="detallePagoModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content ishop-modal p-4">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">Detalle del Pago</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detallePagoBody"></div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let pagos = [];

        // Cargar historial de pagos
        (async () => {
            const container = document.getElementById('ordenesContainer');

            try {
                const res = await fetch('/Orders/PagoHistorialAjax');
                const result = await res.json();

                if (!result.success || !result.data || result.data.length === 0) {
                    container.innerHTML = `<div class="alert alert-warning text-center">No hay pagos registrados</div>`;
                    return;
                }

                pagos = result.data;

                // Agrupar por orden
                const ordenes = [...new Set(pagos.map(p => p.idOrden))];

                container.innerHTML = ordenes.map(idOrden => {
                    const orden = pagos.find(p => p.idOrden === idOrden);

                    return `
                        <div class="col animate-card">
                            <div class="card ishop-card h-100 border-0">
                                <div class="card-body d-flex flex-column justify-content-between">
                                    <div>
                                        <h5 class="fw-bold">Orden #${orden.idOrden}</h5>
                                        <p class="text-muted mb-1">
                                            ${new Date(orden.fechaPago).toLocaleString()}
                                        </p>
                                        <p class="fw-bold text-primary fs-5">
                                            S/ ${orden.monto.toFixed(2)}
                                        </p>
                                        <span class="badge ${orden.estado === "Exitoso" ? "bg-success" : "bg-warning text-dark"}">
                                            ${orden.estado}
                                        </span>
                                    </div>

                                    <button class="btn btn-outline-primary w-100 mt-3"
                                            data-bs-toggle="modal"
                                            data-bs-target="#detallePagoModal"
                                            onclick="verDetalle(${idOrden})">
                                        Ver detalle
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch {
                container.innerHTML = `<div class="alert alert-danger text-center">Error al cargar el historial</div>`;
            }
        })();

        // Mostrar detalle plano (JSON)
        function verDetalle(idOrden) {
            const detalles = pagos.filter(p => p.idOrden === idOrden);

            if (detalles.length === 0) {
                document.getElementById('detallePagoBody').innerHTML =
                    `<div class="alert alert-warning text-center">No hay detalle disponible</div>`;
                return;
            }

            const filas = detalles.map(p => `
                <tr>
                    <td>${p.producto}</td>
                    <td class="text-center">${p.cantidad}</td>
                    <td class="text-end">S/ ${p.precioUnitario.toFixed(2)}</td>
                    <td class="text-end">S/ ${p.subTotal.toFixed(2)}</td>
                </tr>
            `).join('');

            const base = detalles[0];

            document.getElementById('detallePagoBody').innerHTML = `
                <div class="mb-3">
                    <p><strong>Orden:</strong> #${base.idOrden}</p>
                    <p><strong>Usuario:</strong> ${base.usuario}</p>
                    <p><strong>Estado:</strong> ${base.estado}</p>
                    <p><strong>Método:</strong> ${base.metodo}</p>
                </div>

                <table class="table table-sm align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Producto</th>
                            <th class="text-center">Cant</th>
                            <th class="text-end">Precio</th>
                            <th class="text-end">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filas}
                    </tbody>
                </table>

                <h5 class="text-end mt-3 fw-bold">
                    Total: <span class="text-primary">S/ ${base.monto.toFixed(2)}</span>
                </h5>
            `;
        }
    </script>
}

<style>
    :root {
        --orange: #ff6a00;
        --bg: #f5f5f7;
        --text: #1d1d1f;
    }

    body {
        background: var(--bg);
        font-family: 'Inter', sans-serif;
    }

    /* CARDS */
    .ishop-card {
        border-radius: 26px;
        padding: 1rem;
        transition: all .35s ease;
        animation: fadeUp .5s ease both;
    }

        .ishop-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 25px 50px rgba(0,0,0,.15);
        }

    .text-primary {
        color: var(--orange) !important;
    }

    /* MODAL */
    .ishop-modal {
        border-radius: 26px;
        background: #fff;
        animation: scaleIn .35s ease;
    }

    /* BOTONES */
    .btn-outline-primary {
        border-radius: 14px;
        border: 1px solid var(--orange);
        color: var(--orange);
    }

        .btn-outline-primary:hover {
            background: var(--orange);
            color: #fff;
        }

    /* ANIMACIONES (IMPORTANTE: @@ EN RAZOR) */
    @@keyframes fadeUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @@keyframes scaleIn {
        from {
            transform: scale(.95);
            opacity: 0;
        }

        to {
            transform: scale(1);
            opacity: 1;
        }
    }
</style>
